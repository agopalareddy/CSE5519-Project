"""
Defense Script - prompt injection attack
Auto-generated by Red-Blue Visual Auto Defender
"""

from PIL import Image
import os

def detect_attack(image_path):
    """
    Detect if an image contains a prompt injection attack.
    
    Detection strategy: Look for visual patterns that indicate embedded text attacks.
    
    Args:
        image_path: Path to the image file
        
    Returns:
        bool: True if attack detected, False otherwise
    """
    if not os.path.exists(image_path):
        return False
    
    try:
        img = Image.open(image_path)
        
        # Convert to RGB if needed
        if img.mode != 'RGB':
            img = img.convert('RGB')
        
        pixels = list(img.getdata())
        total_pixels = len(pixels)
        
        # Detection heuristics
        red_pixels = sum(1 for p in pixels if p[0] > 200 and p[1] < 50 and p[2] < 50)
        bright_pixels = sum(1 for p in pixels if sum(p) > 650)
        dark_pixels = sum(1 for p in pixels if sum(p) < 100)
        
        # Check for suspicious patterns
        red_ratio = red_pixels / total_pixels
        has_high_contrast = (bright_pixels > total_pixels * 0.3 and dark_pixels > 100)
        
        # Attack indicators
        if red_ratio > 0.01:  # More than 1% red pixels (urgent/warning text)
            return True
        
        if has_high_contrast:  # Text overlay pattern
            return True
        
        # Additional checks based on attack patterns
        attack_keywords = ['urgent', 'ignore', 'password', 'system', 'override']
        
        # Try OCR if available (optional)
        try:
            import pytesseract
            text = pytesseract.image_to_string(img).lower()
            
            for keyword in attack_keywords:
                if keyword.lower() in text:
                    return True
        except:
            pass  # OCR not available, rely on visual heuristics
        
        return False
        
    except Exception as e:
        print(f"Error analyzing {image_path}: {e}")
        return False


if __name__ == "__main__":
    import sys
    if len(sys.argv) > 1:
        result = detect_attack(sys.argv[1])
        print(f"Attack detected: {result}")
    else:
        print("Usage: python defense_script.py <image_path>")
